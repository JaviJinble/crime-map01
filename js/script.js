

const apiKey = "2fKY4BsNc3FoEz9F2cPc59U%2FPMtj8nl%2BsDbjf97ZSkGEBGnKBgAUW4EVr5ZFdOCycOwPEzbzESlB9iR8H9iDrA%3D%3D";
const baseUrl = "https://api.odcloud.kr/api";

const apiUrlMap = {
    "2012": "/3074462/v1/uddi:9ce2c7eb-438b-417e-9986-e458906f2bf6_201910221524",
    "2013": "/3074462/v1/uddi:3621ad6a-4570-49bf-a09b-fe9f4a63a248_201910221518",
    "2014": "/3074462/v1/uddi:efafd73f-3310-48f8-9f56-bddc1c51f3ba_201910221541",
    "2015": "/3074462/v1/uddi:7e73ac26-d0fa-4444-9c2e-81fdad4eff1b_201912061355",
    "2016": "/3074462/v1/uddi:10bde8f1-739c-4b66-b6a6-ccf5339a658e_201910221521",
    "2017": "/3074462/v1/uddi:f046e6e5-58f2-4716-8b74-be62f1a6c6fc_201910221520",
    "2018": "/3074462/v1/uddi:48e1d87b-aaf1-4274-bc0d-a234aeec3889",
    "2019": "/3074462/v1/uddi:c81b4639-53cd-4b18-95ce-f716cc6bf1ff",
    "2020": "/3074462/v1/uddi:5c067b9b-efe1-414a-8096-89b67ee686bf",
    "2021": "/3074462/v1/uddi:14dc5ecc-3702-4df9-9dae-cb2337bf93cb",
    "2022": "/3074462/v1/uddi:fe3ae686-8f7d-4d82-8c3a-901a02a0aa75",
    "2023": "/3074462/v1/uddi:161740bd-8ec5-4734-9a3d-f7a2cde34942"
};

const regionCoordinates = {
    "종로구": { lat: 37.57295, lng: 126.97936 },
    "중구(서울)": { lat: 37.56361, lng: 126.99778 },
    "용산구": { lat: 37.53235, lng: 126.99089 },
    "성동구": { lat: 37.56364, lng: 127.03697 },
    "광진구": { lat: 37.53860, lng: 127.08258 },
    "동대문구": { lat: 37.57436, lng: 127.03956 },
    "중랑구": { lat: 37.59861, lng: 127.09259 },
    "성북구": { lat: 37.60632, lng: 127.02355 },
    "강북구": { lat: 37.63965, lng: 127.02536 },
    "도봉구": { lat: 37.66879, lng: 127.04726 },
    "노원구": { lat: 37.65426, lng: 127.05638 },
    "은평구": { lat: 37.61761, lng: 126.92274 },
    "서대문구": { lat: 37.57931, lng: 126.93684 },
    "마포구": { lat: 37.56638, lng: 126.90149 },
    "양천구": { lat: 37.51240, lng: 126.86584 },
    "강서구(서울)": { lat: 37.55094, lng: 126.84953 },
    "구로구": { lat: 37.49549, lng: 126.88745 },
    "금천구": { lat: 37.45766, lng: 126.89576 },
    "영등포구": { lat: 37.52656, lng: 126.89629 },
    "동작구": { lat: 37.51207, lng: 126.93985 },
    "관악구": { lat: 37.47832, lng: 126.95153 },
    "서초구": { lat: 37.48357, lng: 127.03261 },
    "강남구": { lat: 37.51725, lng: 127.04755 },
    "송파구": { lat: 37.51454, lng: 127.10664 },
    "강동구": { lat: 37.53013, lng: 127.12398 },
    "중구(부산)": { lat: 35.10672, lng: 129.03276 },
    "서구(부산)": { lat: 35.08380, lng: 129.02020 },
    "동구(부산)": { lat: 35.13335, lng: 129.05647 },
    "영도구": { lat: 35.09096, lng: 129.06821 },
    "부산진구": { lat: 35.16284, lng: 129.05313 },
    "동래구": { lat: 35.20422, lng: 129.08355 },
    "남구(부산)": { lat: 35.13669, lng: 129.08400 },
    "북구(부산)": { lat: 35.20911, lng: 129.02653 },
    "강서구(부산)": { lat: 35.21223, lng: 128.98024 },
    "해운대구": { lat: 35.16320, lng: 129.16346 },
    "사하구": { lat: 35.10487, lng: 128.97060 },
    "금정구": { lat: 35.24282, lng: 129.09224 },
    "연제구": { lat: 35.18689, lng: 129.08174 },
    "수영구": { lat: 35.14252, lng: 129.11388 },
    "사상구": { lat: 35.15238, lng: 128.99073 },
    "기장군": { lat: 35.24433, lng: 129.22202 },
    "중구(대구)": { lat: 35.86799, lng: 128.59417 },
    "동구(대구)": { lat: 35.88671, lng: 128.63652 },
    "서구(대구)": { lat: 35.87209, lng: 128.55936 },
    "남구(대구)": { lat: 35.84635, lng: 128.58639 },
    "북구(대구)": { lat: 35.88545, lng: 128.58267 },
    "수성구": { lat: 35.85844, lng: 128.63051 },
    "달서구": { lat: 35.82988, lng: 128.53265 },
    "달성군": { lat: 35.77414, lng: 128.43109 },
    "군위군": { lat: 36.23964, lng: 128.57262 },
    "중구(인천)": { lat: 37.47359, lng: 126.62128 },
    "동구(인천)": { lat: 37.47340, lng: 126.63693 },
    "미추홀구": { lat: 37.46324, lng: 126.65038 },
    "연수구": { lat: 37.41032, lng: 126.67881 },
    "남동구": { lat: 37.44730, lng: 126.73125 },
    "부평구": { lat: 37.50833, lng: 126.72130 },
    "계양구": { lat: 37.53665, lng: 126.73763 },
    "서구(인천)": { lat: 37.54529, lng: 126.67588 },
    "강화군": { lat: 37.74782, lng: 126.48760 },
    "옹진군": { lat: 37.44769, lng: 126.61310 },
    "동구(광주)": { lat: 35.14797, lng: 126.92386 },
    "서구(광주)": { lat: 35.15299, lng: 126.89041 },
    "남구(광주)": { lat: 35.13792, lng: 126.90224 },
    "북구(광주)": { lat: 35.17406, lng: 126.91116 },
    "광산구": { lat: 35.13989, lng: 126.79356 },
    "동구(대전)": { lat: 36.33317, lng: 127.45434 },
    "중구(대전)": { lat: 36.32401, lng: 127.42371 },
    "서구(대전)": { lat: 36.34784, lng: 127.38480 },
    "유성구": { lat: 36.36228, lng: 127.35619 },
    "대덕구": { lat: 36.36472, lng: 127.42322 },
    "세종시": { lat: 36.48024, lng: 127.28928 },
    "서귀포시": { lat: 33.25333, lng: 126.56111 },
    "제주시": { lat: 33.50000, lng: 126.51667 },
    "고양시": { lat: 37.65833, lng: 126.83056 },
    "성남시": { lat: 37.44722, lng: 127.13750 },
    "수원시": { lat: 37.26389, lng: 127.02861 },
    "용인시": { lat: 37.24278, lng: 127.17889 },
    "화성시": { lat: 37.19917, lng: 126.83167 },
    "평택시": { lat: 36.99250, lng: 127.11306 },
    "안산시": { lat: 37.32222, lng: 126.83083 },
    "부천시": { lat: 37.50361, lng: 126.76611 },
    "광명시": { lat: 37.47889, lng: 126.86444 },
    "시흥시": { lat: 37.38139, lng: 126.80278 },
    "파주시": { lat: 37.76111, lng: 126.77778 },
    "이천시": { lat: 37.27222, lng: 127.43500 },
    "김포시": { lat: 37.61528, lng: 126.71528 },
    "여주시": { lat: 37.29889, lng: 127.63750 },
    "오산시": { lat: 37.14917, lng: 127.07750 },
    "군포시": { lat: 37.36250, lng: 126.93333 },
    "하남시": { lat: 37.53917, lng: 127.21417 },
    "안양시": { lat: 37.39444, lng: 126.95556 },
    "구리시": { lat: 37.59444, lng: 127.12972 },
    "의정부시": { lat: 37.73889, lng: 127.03444 },
    "양주시": { lat: 37.78556, lng: 127.04583 },
    "포천시": { lat: 37.89417, lng: 127.20083 },
    "의왕시": { lat: 37.34444, lng: 126.96889 },
    "동두천시": { lat: 37.90306, lng: 127.06139 },
    "과천시": { lat: 37.42917, lng: 126.98750 },
    "양평군": { lat: 37.49139, lng: 127.48722 },
    "가평군": { lat: 37.83167, lng: 127.50917 },
    "연천군": { lat: 38.09667, lng: 127.07528 },
    "춘천시": { lat: 37.88131, lng: 127.72997 },
    "원주시": { lat: 37.34167, lng: 127.92083 },
    "강릉시": { lat: 37.75000, lng: 128.88333 },
    "속초시": { lat: 38.20694, lng: 128.59111 },
    "동해시": { lat: 37.52444, lng: 129.11472 },
    "삼척시": { lat: 37.44972, lng: 129.16583 },
    "태백시": { lat: 37.16417, lng: 128.98556 },
    "홍천군": { lat: 37.69750, lng: 127.88806 },
    "횡성군": { lat: 37.49111, lng: 127.98583 },
    "영월군": { lat: 37.18333, lng: 128.46194 },
    "평창군": { lat: 37.37056, lng: 128.39083 },
    "정선군": { lat: 37.38083, lng: 128.66083 },
    "철원군": { lat: 38.14667, lng: 127.31250 },
    "화천군": { lat: 38.10611, lng: 127.70889 },
    "양구군": { lat: 38.10722, lng: 127.98972 },
    "인제군": { lat: 38.06917, lng: 128.17083 },
    "고성군(강원)": { lat: 38.38083, lng: 128.46722 },
    "양양군": { lat: 38.07583, lng: 128.61917 },
    "제천시": { lat: 37.13250, lng: 128.19167 },
    "청주시": { lat: 36.64389, lng: 127.48944 },
    "충주시": { lat: 36.99278, lng: 127.92611 },
    "보은군": { lat: 36.48950, lng: 127.72954 },
    "옥천군": { lat: 36.30175, lng: 127.57191 },
    "영동군": { lat: 36.17500, lng: 127.77667 },
    "증평군": { lat: 36.78500, lng: 127.58944 },
    "진천군": { lat: 36.85564, lng: 127.43584 },
    "괴산군": { lat: 36.81572, lng: 127.78634 },
    "음성군": { lat: 36.94000, lng: 127.69194 },
    "단양군": { lat: 36.97914, lng: 128.36579 },
    "천안시": { lat: 36.81528, lng: 127.11389 },
    "아산시": { lat: 36.78972, lng: 127.00167 },
    "공주시": { lat: 36.44667, lng: 127.11944 },
    "보령시": { lat: 36.33333, lng: 126.61528 },
    "논산시": { lat: 36.19806, lng: 127.09889 },
    "계룡시": { lat: 36.27429, lng: 127.24827 },
    "당진시": { lat: 36.89181, lng: 126.62913 },
    "서산시": { lat: 36.78500, lng: 126.45056 },
    "태안군": { lat: 36.74500, lng: 126.29778 },
    "홍성군": { lat: 36.60167, lng: 126.66250 },
    "청양군": { lat: 36.45722, lng: 126.80278 },
    "부여군": { lat: 36.27667, lng: 126.90972 },
    "서천군": { lat: 36.07806, lng: 126.68861 },
    "예산군": { lat: 36.68250, lng: 126.84833 },
    "금산군": { lat: 36.10861, lng: 127.48944 },
    "전주시": { lat: 35.82417, lng: 127.14889 },
    "익산시": { lat: 35.95000, lng: 126.95833 },
    "군산시": { lat: 35.96750, lng: 126.73694 },
    "정읍시": { lat: 35.56806, lng: 126.85139 },
    "남원시": { lat: 35.41361, lng: 127.39083 },
    "김제시": { lat: 35.80333, lng: 126.88028 },
    "완주군": { lat: 35.90528, lng: 127.16278 },
    "고창군": { lat: 35.43556, lng: 126.70222 },
    "부안군": { lat: 35.72861, lng: 126.73361 },
    "순창군": { lat: 35.37417, lng: 127.13722 },
    "임실군": { lat: 35.61250, lng: 127.28806 },
    "진안군": { lat: 35.79139, lng: 127.42444 },
    "무주군": { lat: 36.00611, lng: 127.66083 },
    "장수군": { lat: 35.64778, lng: 127.52083 },
    "목포시": { lat: 34.81000, lng: 126.39250 },
    "여수시": { lat: 34.76028, lng: 127.66250 },
    "순천시": { lat: 34.94917, lng: 127.48750 },
    "광양시": { lat: 34.94000, lng: 127.69500 },
    "나주시": { lat: 35.01694, lng: 126.71278 },
    "담양군": { lat: 35.32194, lng: 127.00639 },
    "곡성군": { lat: 35.28111, lng: 127.28917 },
    "구례군": { lat: 35.20222, lng: 127.46250 },
    "고흥군": { lat: 34.61194, lng: 127.28222 },
    "보성군": { lat: 34.77139, lng: 127.07917 },
    "화순군": { lat: 35.06111, lng: 126.98528 },
    "장흥군": { lat: 34.68389, lng: 126.90250 },
    "강진군": { lat: 34.64250, lng: 126.76917 },
    "해남군": { lat: 34.57250, lng: 126.59972 },
    "영암군": { lat: 34.80000, lng: 126.69639 },
    "무안군": { lat: 34.99056, lng: 126.47778 },
    "함평군": { lat: 35.06333, lng: 126.51611 },
    "영광군": { lat: 35.27722, lng: 126.51222 },
    "장성군": { lat: 35.30056, lng: 126.78417 },
    "완도군": { lat: 34.31167, lng: 126.75639 },
    "진도군": { lat: 34.48333, lng: 126.26389 },
    "신안군": { lat: 34.82639, lng: 126.38056 },
    "포항시": { lat: 36.01944, lng: 129.34167 },
    "경주시": { lat: 35.85611, lng: 129.22472 },
    "김천시": { lat: 36.13972, lng: 128.11389 },
    "안동시": { lat: 36.56889, lng: 128.72944 },
    "구미시": { lat: 36.11944, lng: 128.34472 },
    "영주시": { lat: 36.80500, lng: 128.62333 },
    "영천시": { lat: 35.97333, lng: 128.93889 },
    "상주시": { lat: 36.41528, lng: 128.15972 },
    "문경시": { lat: 36.58639, lng: 128.18750 },
    "군위군": { lat: 36.24000, lng: 128.57250 },
    "의성군": { lat: 36.35222, lng: 128.69778 },
    "청송군": { lat: 36.43556, lng: 129.05778 },
    "영양군": { lat: 36.66472, lng: 129.11278 },
    "영덕군": { lat: 36.41556, lng: 129.36556 },
    "청도군": { lat: 35.64750, lng: 128.73694 },
    "고령군": { lat: 35.72889, lng: 128.26833 },
    "성주군": { lat: 35.91944, lng: 128.28333 },
    "칠곡군": { lat: 36.01500, lng: 128.40167 },
    "예천군": { lat: 36.65528, lng: 128.45278 },
    "봉화군": { lat: 36.89306, lng: 128.73222 },
    "울진군": { lat: 36.99306, lng: 129.40000 },
    "울릉군": { lat: 37.48528, lng: 130.90611 },
    "창원시": { lat: 35.22917, lng: 128.67500 },
    "진주시": { lat: 35.18083, lng: 128.10778 },
    "통영시": { lat: 34.85444, lng: 128.43361 },
    "사천시": { lat: 35.00333, lng: 128.06444 },
    "김해시": { lat: 35.22889, lng: 128.88944 },
    "밀양시": { lat: 35.49333, lng: 128.74639 },
    "거제시": { lat: 34.88000, lng: 128.62139 },
    "양산시": { lat: 35.33556, lng: 129.03778 },
    "의령군": { lat: 35.32333, lng: 128.25972 },
    "함안군": { lat: 35.27250, lng: 128.40611 },
    "창녕군": { lat: 35.54417, lng: 128.50667 },
    "고성군(경남)": { lat: 34.97361, lng: 128.32278 },
    "남해군": { lat: 34.83722, lng: 127.89222 },
    "하동군": { lat: 35.06722, lng: 127.75111 },
    "산청군": { lat: 35.41361, lng: 127.87389 },
    "함양군": { lat: 35.52083, lng: 127.72583 },
    "거창군": { lat: 35.68778, lng: 127.90944 },
    "합천군": { lat: 35.56611, lng: 128.16528 },
    "서귀포시": { lat: 33.25333, lng: 126.56111 },
    "제주시": { lat: 33.50000, lng: 126.51667 },
};
// 도시 이름 표준화 함수
function normalizeCityName(city) {
    const normalizedCity = city
        .replace(/특별시|광역시|시|구|군/g, "") // 접미어 제거
        .replace(/\(.*?\)/g, "") // 괄호 내용 제거
        .trim(); // 공백 제거
    
    console.log(`원본 도시 이름: "${city}", 표준화된 도시 이름: "${normalizedCity}"`); // 디버깅 로그
    return normalizedCity;
}

// Kakao 지도 초기화
const mapContainer = document.getElementById('map');
const mapOption = {
    center: new kakao.maps.LatLng(36.5, 127.8),
    level: 13, // 지도 줌 수준
};
const map = new kakao.maps.Map(mapContainer, mapOption);

// API 데이터 가져오기
async function fetchCrimeData2023() {
    const apiUrl = `${baseUrl}${apiUrlMap["2023"]}?page=1&perPage=100&serviceKey=${apiKey}`;
    console.log(`API 호출 URL: ${apiUrl}`); // 디버깅 로그
    try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        const data = await response.json();
        console.log("API 응답 데이터:", data); // 디버깅 로그
        return data.data; // 데이터 배열 반환
    } catch (error) {
        console.error("2023년 데이터 가져오기 실패:", error);
        return [];
    }
}

// 마커 생성 함수
async function loadMarkersFor2023() {
    const crimeData = await fetchCrimeData2023();
    if (!crimeData.length) {
        console.error("2023년 범죄 데이터가 없습니다.");
        return;
    }

    console.log("가져온 2023년 범죄 데이터:", crimeData); // 디버깅 로그

    crimeData.forEach(item => {
        const { city, 범죄대분류, 범죄중분류, 발생건수 } = item;
        const normalizedCity = normalizeCityName(city); // 도시 이름 표준화
        const region = regionCoordinates[normalizedCity];

        if (!region) {
            console.warn(`"${normalizedCity}"의 지역 좌표를 찾을 수 없습니다.`);
            return;
        }

        console.log(`"${normalizedCity}" 좌표: ${JSON.stringify(region)}`); // 디버깅 로그

        // Kakao 지도 마커 생성
        const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(region.lat, region.lng),
            map: map,
        });

        // 마우스 오버 시 표시할 정보
        const infowindowContent = `
            <div style="padding:5px;">
                <strong>${normalizedCity}</strong><br>
                <strong>범죄 대분류:</strong> ${범죄대분류 || "정보 없음"}<br>
                <strong>범죄 중분류:</strong> ${범죄중분류 || "정보 없음"}<br>
                <strong>발생 건수:</strong> ${발생건수 || "정보 없음"}
            </div>
        `;

        const infowindow = new kakao.maps.InfoWindow({
            content: infowindowContent,
        });

        // 마우스 이벤트 등록
        kakao.maps.event.addListener(marker, 'mouseover', () => {
            console.log(`"${normalizedCity}" 마커 정보창 열림.`); // 디버깅 로그
            infowindow.open(map, marker);
        });
        kakao.maps.event.addListener(marker, 'mouseout', () => {
            console.log(`"${normalizedCity}" 마커 정보창 닫힘.`); // 디버깅 로그
            infowindow.close();
        });
    });
}

// 초기화 함수
async function init() {
    try {
        console.log("초기화 시작."); // 디버깅 로그
        await loadMarkersFor2023(); // 2023년 마커 표시
        console.log("마커 표시 완료."); // 디버깅 로그
    } catch (error) {
        console.error("초기화 실패:", error);
    }
}

// 실행
init();
